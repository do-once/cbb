{"version":3,"file":"DoonceThemeService.js","sourceRoot":"","sources":["../src/DoonceThemeService.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @author GuangHui\n * @description DoonceThemeService 主体程序\n */\n\nimport { canSupportCssVar, uuid, loadJs } from '@doonce/utils'\n\nexport type ThemeTuple = [string, string][]\n\n/**\n * 主题服务\n *\n * @date 2021-06-24 10:28:29\n * @export\n * @class ThemeService\n */\nexport class DoonceThemeService {\n  private styleEl: HTMLStyleElement | null = null\n  private styleElId: string = ''\n\n  /**\n   * 应用主题\n   *\n   * @date 2021-06-24 10:30:20\n   * @public\n   * @instance\n   * @param {Array} themeTuple  主题配置数组(二元数组)，参照上面使用demo\n   * @memberof ThemeService\n   */\n  applyTheme(themeTuple: ThemeTuple): void {\n    if (!Array.isArray(themeTuple) || !themeTuple.length) return\n\n    if (typeof MutationObserver === 'function') {\n      if (canSupportCssVar()) {\n        this._apply(themeTuple)\n      } else {\n        this._loadCssVarsPonyfill().then(res => {\n          this._apply(themeTuple)\n        })\n      }\n    } else {\n      this._loadMutationObserverPolyfill().then(() => {\n        if (canSupportCssVar()) {\n          this._apply(themeTuple)\n        } else {\n          this._loadCssVarsPonyfill().then(res => {\n            this._apply(themeTuple)\n          })\n        }\n      })\n    }\n  }\n\n  /**\n   * 销毁\n   *\n   * @date 2021-06-24 10:30:34\n   * @public\n   * @instance\n   * @memberof ThemeService\n   */\n  destroy() {\n    if (this.styleEl) {\n      document.head.removeChild(this.styleEl)\n\n      this.styleEl = null\n    }\n\n    this.styleElId && (this.styleElId = '')\n  }\n\n  /**\n   * 应用主题数组\n   *\n   * @date 2021-06-24 10:30:51\n   * @private\n   * @param {Array} themeTuple 主题配置数组\n   * @memberof ThemeService\n   */\n  _apply(themeTuple: ThemeTuple) {\n    const cssText = this._genCssText(themeTuple)\n\n    if (!this.styleEl) {\n      this.styleEl = document.createElement('style')\n      this.styleEl.innerText = `:root{${cssText}}`\n      this.styleElId = uuid()\n      this.styleEl.setAttribute('data-theme-id', this.styleElId)\n      document.head.appendChild(this.styleEl)\n    } else {\n      this.styleEl.innerText = `:root{${cssText}}`\n    }\n  }\n\n  /**\n   * 加载MutationObserverPolyfill\n   *\n   * @date 2021-06-24 10:31:03\n   * @private\n   * @return {Promise} promise实例\n   * @memberof ThemeService\n   */\n  _loadMutationObserverPolyfill() {\n    return import(/* webpackChunkName:'mutationobserver-shim' */ 'mutationobserver-shim').catch(err => {\n      console.log('加载mutationobserver-shim失败', err)\n    })\n  }\n\n  /**\n   * 加载CssVarsPonyfill\n   *\n   * @date 2021-06-24 10:31:22\n   * @private\n   * @return {Promise} promise实例\n   * @memberof ThemeService\n   */\n  _loadCssVarsPonyfill() {\n    return import(/* webpackChunkName:'css-vars-ponyfill' */ 'css-vars-ponyfill')\n      .then(({ default: cssVars }) => {\n        // https://jhildenbiddle.github.io/css-vars-ponyfill/#/\n        const config = {\n          watch: true,\n          preserveVars: true,\n          silent: false /* 若为静默模式不会输出log */\n        }\n\n        cssVars(config)\n\n        return true\n      })\n      .catch(err => {\n        console.log('加载css-vars-ponyfill失败', err)\n      })\n  }\n\n  /**\n   * 生成样式字符串\n   *\n   * @date 2021-06-24 10:31:36\n   * @private\n   * @param {ThemeTuple} themeTuple  主题配置数组\n   * @return {String} css var 样式字符串\n   * @memberof ThemeService\n   */\n  _genCssText(themeTuple: ThemeTuple) {\n    return themeTuple.map(([prop, val]) => `${prop.startsWith('--') ? '' : '--'}${prop}:${val};`).join('')\n  }\n}\n"]}